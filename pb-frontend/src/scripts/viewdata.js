// this file contains all elements necessary to visualize data on the view data page
// we hold data from the server in totalData and currentData
// state, nationalForest, forest, startDate and endDate are user selections on screen
// helper methods are defined below


// user selections for state, region, and whether or not to view data for all of the US or just a specific state-region combination
var state = null;
var nationalForest = null;
var forest = null;
var showUS = true;

// user selections for date range
var startDate = Infinity;
var endDate = 0;

// original date selections
var originalStartDate = startDate;
var originalEndDate = endDate;

var totalData = []; // entire dataset available to the user
var currentData = []; // just the data that the user wants to look at based on current selection

var stateAbbrevToStateName = {
    AL:"Alabama",
    AR:"Arkansas",
    DE:"Delaware",
    FL:"Florida",
    GA:"Georgia",
    KY:"Kentucky",
    LA:"Louisiana",
    MD:"Maryland",
    MS:"Mississippi",
    NC:"North Carolina",
    NJ:"New Jersey",
    OK:"Oklahoma",
    SC:"South Carolina",
    TN:"Tennesse",
    TX:"Texas",
    VA:"Virginia"
}

// array of national and local forests available for the user to select - for selection menus only
var availableNationalForests = [];
var availableLocalForests = [];

const local = 'historical_data.json'
const localURL = "http://localhost:9090/v1/getHistoricals"
const deployedURL = "https://pine-beetle-prediction.herokuapp.com/v1/getHistoricals"
// get local data and assign total and local data arrays
getDataFromLocal(local);

//Source: https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/responseXML
function getDataFromLocal(url) {
  // console.log("Running!!!");
  var xhr = new XMLHttpRequest;
  xhr.open('GET', url, true);
  xhr.responseType = 'json';
  xhr.onload = function() {
    if (xhr.readyState === xhr.DONE) {
      if (xhr.status === 200) {
        // console.log("Completed!");
        // console.log(xhr.response);

        // refresh list of available states and regions
        totalData = xhr.response;
        currentData = totalData;

        // update start and end dates initially available to user and hold onto original dates
        updateStartAndEndDateFromCurrentData();
        originalStartDate = startDate;
        originalEndDate = endDate;
        document.getElementById('start-year-input').value = startDate;
        document.getElementById('end-year-input').value = endDate;

        refreshSelectionMenus();
        initializeStateDropDownMenu();
        refreshDataVisualizations();

        buildMap();
      }
    }
  };
  xhr.send();
};

// updates currentData that will be visualized on screen
function refreshCurrentData() {
    var newSet = [];

    // if the user hasn't selected a state, take all of the data in date range
    if (state == null) {
        for (i in totalData) {
            // ensure in proper date range
            if ((totalData[i].year >= startDate && totalData[i].year <= endDate)) {
                newSet.push(totalData[i]);
            }
        }
    }
    else {
        for (i in totalData) {
            // ensure in proper date range and state
            if ((totalData[i].year >= startDate && totalData[i].year <= endDate && totalData[i].state === state)) {

                // handle case where user selects only a state
                if (nationalForest == null && forest == null) {
                    newSet.push(totalData[i]);
                }

                // handle case where user selects state and national forest but not local
                else if (nationalForest != null && forest == null) {
                    if (totalData[i].nf === nationalForest) {
                        newSet.push(totalData[i]);
                    }
                }

                // handle case where user selects state  and local forest but not national
                else if (nationalForest == null && forest != null) {
                    if (totalData[i].forest === forest) {
                        newSet.push(totalData[i]);
                    }
                }

                // handle case where user selects state, national forest, and local forest
                else if (nationalForest != null && forest != null) {
                    if (totalData[i].nf === nationalForest && totalData[i].forest === forest) {
                        newSet.push(totalData[i]);
                    }
                }
            }
        }
    }

    // store new data
    currentData = newSet;

    console.log(currentData);
    console.log(state);
    console.log(nationalForest);
    console.log(forest);

    // refresh graphs and beetle counts in the data insights section
    refreshDataVisualizations();

    // update the Esri map
    updateMap();
}

// updates the start and end dates for the available data
function updateStartAndEndDateFromCurrentData() {
    for (obj in currentData) {
        // set startDate
        if (currentData[obj].year < startDate) {
            startDate = currentData[obj].year;
        }
        // set endDate
        if (currentData[obj].year > endDate) {
            endDate = currentData[obj].year;
        }
    }
}

// trigger function for when user presses enter in start date field
document.getElementById('start-year-input').onkeypress=function(e) {
    if(e.keyCode==13){
        document.getElementById('start-year-submit').click();
    }
}

// trigger function for when user presses enter in end date field
document.getElementById('end-year-input').onkeypress=function(e) {
    if(e.keyCode==13){
        document.getElementById('end-year-submit').click();
    }
}

// trigger function for when user adjusts start date
function updateStartDate() {
    userEntry = document.getElementById('start-year-input').value;

    if (Number.isInteger(parseInt(userEntry, 10)) && userEntry >= originalStartDate && userEntry <= originalEndDate && userEntry<=endDate) {
        startDate = userEntry;
        refreshCurrentData();
        console.log("start date is now: " + startDate);
    }

    else {
        document.getElementById('start-year-input').value = startDate;
    }
}

// trigger function for when user adjusts end date
function updateEndDate() {
    userEntry = document.getElementById('end-year-input').value;

    if (Number.isInteger(parseInt(userEntry, 10)) && userEntry <= originalEndDate && userEntry >= originalStartDate && userEntry>=startDate) {
        endDate = userEntry;
        refreshCurrentData();
        console.log("end date is now: " + endDate);
    }

    else {
        document.getElementById('end-year-input').value = endDate;
    }
}

// trigger function for when user adjusts state
function changeStateSelection() {
    if (showUS) {
        showUS = false;

        // update button coloring
        document.getElementById("select-buttons").children[0].removeAttribute("id");
        document.getElementById("select-buttons").children[1].setAttribute("id","active");

        // show region area and change user instructions on screen
        if (forest != null) {$("#forest").slideDown();}
        if (nationalForest != null) {$("#nf").slideDown();}

        document.getElementById('click-instructions').innerHTML = "Click <strong>United States</strong> to view metrics for the whole nation.";
    }

    // if user wants to reset state to null
    if (document.getElementById('state-select').value == "null") {
        resetCurrentData();
        document.getElementById('state-select').children[0].innerHTML = "Select State";
    }

    else {
        // update global variable to the newly selected state and get stateName
        state = document.getElementById('state-select').value
        stateName = stateAbbrevToStateName[state];

        nationalForest = null;
        forest = null;

        availableNationalForests = [];
        availableLocalForests = [];

        // refresh the data available for analysis
        refreshCurrentData();

        // update the drop down menu of new forests
        refreshSelectionMenus();

        // update all text fields on screen
        updateStateTextFields(stateName);
        updateNationalForestTextFields();
        updateForestTextFields();

        // clear forest selection menus
        document.getElementById('nf-select').selectedIndex = "0";
        document.getElementById('forest-select').selectedIndex = "0";

        $("#forest").slideUp();
        $("#nf").slideUp();

        // change selection option text
        document.getElementById('state-select').children[0].innerHTML = "Clear State Selection";
    }

    refreshSelectionMenus();
}

// trigger function for when user adjusts national forest
function changeNationalForestSelection() {
    if (document.getElementById('nf-select').value == "null") {
        nationalForest = null;
        refreshCurrentData();
        $("#nf").slideUp();
        document.getElementById('nf-select').children[0].innerHTML = "Select National Forest";
    }

    else {
        nationalForest = document.getElementById('nf-select').value
        updateNationalForestTextFields();

        // refresh the data available for analysis
        refreshCurrentData();

        // display prediction areas as necessary
        if (forest != null) {$("#forest").slideDown();}
        if (nationalForest != null) {$("#nf").slideDown();}

        // change selection option text
        document.getElementById('nf-select').children[0].innerHTML = "Clear Natl Forest Selection";
    }

    refreshSelectionMenus();
}

// trigger function for when user adjusts local forest
function changeForestSelection() {
    if (document.getElementById('forest-select').value == "null") {
        forest = null;
        refreshCurrentData();
        $("#forest").slideUp();

        if (nationalForest == null) {
            $("#nf").slideUp();
        }

        document.getElementById('forest-select').children[0].innerHTML = "Select Forest";
    }

    else {
        forest = document.getElementById('forest-select').value
        updateForestTextFields();

        // refresh the data available for analysis
        refreshCurrentData();

        // display prediction areas as necessary
        if (forest != null) {$("#forest").slideDown();}
        if (nationalForest != null) {$("#nf").slideDown();}

        // change selection option text
        document.getElementById('forest-select').children[0].innerHTML = "Clear Forest Selection";
    }

    refreshSelectionMenus();
}

// trigger function for when user wants to switch between viewing data for all US or just a specific state
function switchNationSelection(newSelect) {
    // if the user wants to see only metrics for the United States
    if (newSelect === "us") {
        showUS = true;
        state = null;
        nationalForest = null;
        forest = null;

        availableNationalForests = [];
        availableLocalForests = [];

        // update button coloring
        document.getElementById("select-buttons").children[0].setAttribute("id","active");
        document.getElementById("select-buttons").children[1].removeAttribute("id");

        // hide region area and change user instructions
        $("#forest").slideUp();
        $("#nf").slideUp();
        document.getElementById('click-instructions').innerHTML = "Click <strong>State Selection</strong> to view metrics in specific states.";

        // change state to United States
        textFields = document.getElementsByClassName("state-text");
        for (i = 0; i < textFields.length; i++) {
            textFields[i].innerHTML = "United States";
        }

        // refresh the data available for analysis and reset
        refreshCurrentData();
        refreshSelectionMenus();

        // change selection menus to default selection
        document.getElementById('state-select').selectedIndex = "0";
        document.getElementById('nf-select').selectedIndex = "0";
        document.getElementById('forest-select').selectedIndex = "0";
    }
    // if the user wants to see metrics for a specific location
    else {
        showUS = false;

        // update button coloring
        document.getElementById("select-buttons").children[0].removeAttribute("id");
        document.getElementById("select-buttons").children[1].setAttribute("id","active");

        // show region area and change user instructions
        if (forest != null) {$("#forest").slideDown();}
        if (nationalForest != null) {$("#nf").slideDown();}
        document.getElementById('click-instructions').innerHTML = "Click <strong>United States</strong> to view metrics for the whole nation.";

        // refresh the list of available states and regions on the screen
        refreshSelectionMenus();

        // update selection menus and text fields
        document.getElementById('state-select').selectedIndex = "1";
        changeStateSelection();

        // refresh the data available for analysis
        refreshCurrentData();
    }
}

// refreshes the selection menus based on the available data for the desired dates, state, and region
function refreshSelectionMenus() {
    updateAvailableStatesAndForestsInDropDown();
    clearSelectionOptionNodes();
    updateNationalForestDropDown();
    updateForestDropDown();
}

// update the arrays of available forests to be placed in drop down menus based on current data
function updateAvailableStatesAndForestsInDropDown() {
    // clear arrays
    availableNationalForests = [];
    availableLocalForests = [];

    for (obj in currentData) {
        // grab national forest and local forests
        thisNF = currentData[obj].nf;
        thisForest = currentData[obj].forest;

        // add to arrays
        if (!availableNationalForests.includes(thisNF) && thisNF != "") {
            availableNationalForests.push(thisNF);
        }
        if (!availableLocalForests.includes(thisForest) && thisForest != "") {
            availableLocalForests.push(thisForest);
        }
    }
}

// remove all option elements that are child nodes of the region selection menu
function clearSelectionOptionNodes() {
    // grab a reference to DOM nf select node and its children
    nfSelectNode = document.getElementById('nf-select');
    optionDivs = nfSelectNode.children;

    // remove all children of the select menu but the default select region
    while (optionDivs.length > 1) {
        optionDivs[1].remove();
    }

    // grab a reference to DOM forest select node and its children
    forestSelectNode = document.getElementById('forest-select');
    optionDivs = nfSelectNode.children;

    // remove all children of the select menu but the default select region
    while (optionDivs.length > 1) {
        optionDivs[1].remove();
    }
}

function initializeStateDropDownMenu() {
    // grab a reference to DOM state select node and its children
    stateSelectNode = document.getElementById('state-select');
    optionDivs = stateSelectNode.children;

    // iterate over each state abbreviation in the abbreviations map
    for (var stateAbbrev in stateAbbrevToStateName) {
        // add a state selection option for each state in the map
        optionElement = document.createElement("OPTION");
        optionElement.setAttribute('value', stateAbbrev);
        textField = document.createTextNode(stateAbbrevToStateName[stateAbbrev]);
        optionElement.appendChild(textField);
        stateSelectNode.appendChild(optionElement);
    }
}

// update all national forest dropdown options in the DOM
function updateNationalForestDropDown() {
    if (state != null) {
        // grab a reference to DOM region select node and its children
        nfSelectNode = document.getElementById('nf-select');
        optionDivs = nfSelectNode.children;

        // remove all children of the select menu but the default select region
        while (optionDivs.length > 1) {
            optionDivs[1].remove();
        }

        // add option elements to the select menu for each region associated with
        // the current state that the user selected
        for (i in availableNationalForests) {
            optionElement = document.createElement("OPTION");
            optionElement.setAttribute('value',availableNationalForests[i]);
            textField = document.createTextNode(availableNationalForests[i]);
            optionElement.appendChild(textField);
            nfSelectNode.appendChild(optionElement);

            if (nationalForest!=null && availableNationalForests[i]==nationalForest) {
                document.getElementById('nf-select').selectedIndex = i+1;
            }
        }
    }
}

// update all national forest dropdown options in the DOM
function updateForestDropDown() {
    if (state != null) {
        // grab a reference to DOM region select node and its children
        forestSelectNode = document.getElementById('forest-select');
        optionDivs = forestSelectNode.children;

        // remove all children of the select menu but the default select region
        while (optionDivs.length > 1) {
            optionDivs[1].remove();
        }

        // add option elements to the select menu for each region associated with
        // the current state that the user selected
        for (i in availableLocalForests) {
            optionElement = document.createElement("OPTION");
            optionElement.setAttribute('value',availableLocalForests[i]);
            textField = document.createTextNode(availableLocalForests[i]);
            optionElement.appendChild(textField);
            forestSelectNode.appendChild(optionElement);

            if (forest!=null && availableLocalForests[i]==forest) {
                document.getElementById('forest-select').selectedIndex = i+1;
            }
        }
    }
}

// helper function: change dom elements to new state selection
function updateStateTextFields(stateName) {
    textFields = document.getElementsByClassName("state-text");

    for (i = 0; i < textFields.length; i++) {
        textFields[i].innerHTML = stateName;
    }
}

// helper function: change dom elements to new nf selection
function updateNationalForestTextFields() {
    textFields = document.getElementsByClassName("nf-text");

    for (i = 0; i < textFields.length; i++) {
        textFields[i].innerHTML = nationalForest;
    }
}

// helper function: change dom elements to new forest selection
function updateForestTextFields() {
    textFields = document.getElementsByClassName("forest-text");

    for (i = 0; i < textFields.length; i++) {
        textFields[i].innerHTML = forest;
    }
}

// toggle view function
// moves the prediction model into the data-analytics area
function movePredictionModelDown() {
    // grab references
    mapArea = document.getElementById('map-area');
    predModel = document.getElementById('prediction-model');
    dataInsightsHolder = document.getElementById('data-insights-holder');

    // move DOM nodes and remove styling class
    dataInsightsHolder.appendChild(predModel);
    document.getElementById('data-insights').classList.add("flex-item-left");
    mapArea.classList.remove("flex-item-left");


    // adjust onclick event
    document.getElementById('adjust-map-size-button').setAttribute( "onclick", "swapMapAndDataInsights('round1');");
}

// toggle view function
// reorder the map area and the data insights area
function swapMapAndDataInsights(round) {
    container = document.getElementById('content');
    dataInsightsHolder = container.children[2];
    mapAreaContainer = container.children[1];

    // change the order
    container.removeChild(mapAreaContainer);
    container.appendChild(mapAreaContainer);

    // adjust onclick event
    if (round == "round1") {
        document.getElementById('adjust-map-size-button').setAttribute( "onclick", "movePredictionModelUp();");
    }
    else {
        document.getElementById('adjust-map-size-button').setAttribute( "onclick", "movePredictionModelDown();");
    }
}

// toggle view function
// moves the prediction model up into the map area
function movePredictionModelUp() {
    // grab references
    mapArea = document.getElementById('map-area');
    predModel = document.getElementById('prediction-model');
    mapAreaContainer = document.getElementById('map-area-container');

    // move DOM nodes and remove styling class
    mapAreaContainer.appendChild(predModel);
    mapArea.classList.add("flex-item-left");
    document.getElementById('data-insights').classList.remove("flex-item-left");

    // adjust onclick event
    document.getElementById('adjust-map-size-button').setAttribute( "onclick", "swapMapAndDataInsights('round2');");
}

// trigger function when user presses reset data button
function resetCurrentData() {
    // set current to total and update menus/dropdowns
    currentData = totalData;
    updateStartAndEndDateFromCurrentData();
    document.getElementById('start-year-input').value = startDate;
    document.getElementById('end-year-input').value = endDate;
    refreshSelectionMenus();
    switchNationSelection('us');
    document.getElementById('nf-select').selectedIndex = "0";
    document.getElementById('forest-select').selectedIndex = "0";

    state = null;
    nationalForest = null;
    forest = null;

    availableNationalForests = [];
    availableLocalForests = [];

    document.getElementById('state-select').children[0].innerHTML = "Select State";
    document.getElementById('nf-select').children[0].innerHTML = "Select National Forest";
    document.getElementById('forest-select').children[0].innerHTML = "Select Forest";
}

// start the loading animation for the prediction model area - call this function, then run the model
// parameter id is prediction-model for the loading over the prediction model area and map-area for the esri map
function startLoadingAnimation(id) {
    // grab children and set opacity of all elements in the div to 0.2
    areaDivElements = document.getElementById(id).children;

    for (i=0;i<areaDivElements.length-1;i++) {
        if (areaDivElements[i].id != (id + "-load-icon")) {
            areaDivElements[i].style.opacity = 0.15;
        }
    }

    // add load icon
    document.getElementById(id + '-load-icon').style.opacity = 1;
}

// stop the loading animation for the predictino model area - call this function after the model finishes running
// parameter id is prediction-model for the loading over the prediction model area and map-area for the esri map
function stopLoadingAnimation(id) {
    // remove load icon
    document.getElementById(id + '-load-icon').style.opacity = 0;

    // grab children and set opacity of all elements in the div back to 1
    areaDivElements = document.getElementById(id).children;

    for (i=0;i<areaDivElements.length-1;i++) {
        if (areaDivElements[i].id != (id + "-load-icon")) {
            areaDivElements[i].style.opacity = 1;
        }
    }
}

// update dom elements in data insights section
function refreshDataVisualizations() {
    var totalCleridsPerTwoWeeks = 0;
    var totalSPBPerTwoWeeks = 0;
    var totalPercentSPB = 0;
    var totalSpots = 0;
    var totalSpotsPerHundredKM = 0;

    for (obj in currentData) {
        totalCleridsPerTwoWeeks += currentData[obj].cleridsPerTwoWeeks;
        totalSPBPerTwoWeeks += currentData[obj].spbPerTwoWeeks;
        totalPercentSPB += currentData[obj].percentSpb;
        totalSpots += currentData[obj].spots;
        totalSpotsPerHundredKM += currentData[obj].spotsPerHundredKm;
    }

    document.getElementById('total-clerids-per-two-weeks').innerHTML = "Total Clerids Per Two Weeks: " + totalCleridsPerTwoWeeks.toLocaleString(); // toLocalString adds commas for thousands places
    document.getElementById('total-spb-per-two-weeks').innerHTML = "Total SPB Per Two Weeks: " + totalSPBPerTwoWeeks.toLocaleString();
    document.getElementById('avg-percent-spb').innerHTML = "Average Percent SPB: " + (totalPercentSPB / currentData.length).toFixed(2) + "%";  // toFixed is number of decimal places
    document.getElementById('total-spots').innerHTML = "Total Spots: " + totalSpots.toLocaleString();
    document.getElementById('total-spots-per-hundred-km').innerHTML = "Total Spots Per Hundred KM: " + totalSpotsPerHundredKM.toLocaleString();
}


// THIS IS EVERYTHING FOR THE MAP - WE ARE HAVING PROBLEMS CALLING FUNCTIONS FROM OTHER JS FILES SO IT'S ALL HERE
// NOTE: to adjust/change things on the map, change attributes of the variables defined below
// if you want to redraw all of the dots on the map, don't call buildMap(), remove/add stuff in view.graphics (might be worth considering combining the Graphic objects constructed below and everything in currentData/totalData so you have one source of truth...)

// variables used for the map
// by making them global variables, we can call them in other functions and easily adjust things on the map
// view holds the graphics layer - this is where you can access all the dots on the map
var map, view, point, markerSymbol, pointAtt, pointGraphic;

// constructs everything required for the map
// called once in the load data function
function buildMap() {
    require([
    "esri/Map",
    "esri/views/MapView",
    "esri/Graphic"
    ], function(Map,MapView,Graphic) {

        // base layer map
        map = new Map({
          basemap: "streets"
        });

        // map view - holds graphics, points, etc.
        view = new MapView({
          center: [-84.3880, 33.7490],
          container: "viewDiv",
          map: map,
          zoom: 5.5
        });

        // create SimpleMarkerSymbol object for drawing the point (basically a circle)
        // defining this outside the loop because only have to construct once
        markerSymbol = {
            type: "simple-marker",  // autocasts as new SimpleMarkerSymbol()
            color: [233,196,106],
            size: "13px",  // pixels
            outline: {  // autocasts as new SimpleLineSymbol()
                color: [36,66,79],
                width: 1  // points
            }
        };

        // iterate through current data and add points to map
        for (i in totalData) {
            // first check to make sure we have a place to put the point
            if (totalData[i].latitude != null && totalData[i].longitude != null) {
                // create Point object - just location on the map to store point
                point = {
                    type: "point",  // autocasts as new Point()
                    longitude: totalData[i].longitude,
                    latitude: totalData[i].latitude
                };

                // clone the JSON object associated with this point and pass it as an attribute object to the Graphic object
                // this is basically just associated data that is accessible in the menu that appears when a user clicks on a dot
                pointAtt = Object.assign({}, totalData[i]);

                // update name attribute based on if we have national forest, local, etc.
                if (totalData[i].nf != null && totalData[i].nf != "" && totalData[i].nf != undefined) {
                    pointAtt.Name = totalData[i].nf + " NATL FOREST";
                }
                else if (totalData[i].forest != null && totalData[i].forest != "" && totalData[i].forest != undefined) {
                    pointAtt.Name = totalData[i].forest + " STATE FOREST";
                }
                else {
                    pointAtt.Name = "STATE: " + totalData[i].state;
                }

                 // create a new graphic and add the geometry, symbol, and attributes to it
                 // also add simple PopupTemplate allowing users to view graphic's attributes when clicked
                 // this basically puts everything we constructed above together
                 pointGraphic = new Graphic({
                     geometry: point,
                     symbol: markerSymbol,
                     attributes: pointAtt,
                     popupTemplate: {  // autocasts as new PopupTemplate()
                         title: "{Name}",
                         content: [{
                             type: "fields",
                             fieldInfos: [{
                                 fieldName: "Name"
                             }, {
                                 fieldName: "year"
                             }, {
                                 fieldName: "percentSpb"
                             }, {
                                 fieldName: "cleridsPerTwoWeeks"
                             }, {
                                 fieldName: "spbPerTwoWeeks"
                             }]
                         }]
                     }
                 });

                // Add the point graphic to the view's GraphicsLayer - basically put it on the map
                view.graphics.add(pointGraphic);

                // store this Graphic object in the JSON data in totalData
                totalData[i].mapObject = pointGraphic;
            }
        }

        // update currentData based on totalData
        currentData = totalData;
    });
}

// only put dots on the map if that object is in currentData
// this function is called from refreshCurrentData
function updateMap() {
    // clear the Graphics layer
    for (i in totalData) {
        // first check to make sure we have a place to put the point
        if (totalData[i].latitude != null && totalData[i].longitude != null) {
            view.graphics.remove(totalData[i].mapObject);
        }
    }

    // iterate through current data and add points to map
    for (i in currentData) {
        view.graphics.add(currentData[i].mapObject);
    }
}
